%p 
= render :partial => 'widgets/canvas_feed', :object => @widget, :as => :widget


- if current_user
  #follow_status
    #follow
      %button Follow
    #unfollow
      %button Stop following
      Following this widget

:javascript
  var widget_id = #{@widget.id};

  var user = {
    is_logged_in : #{!current_user.nil?},
    is_following : #{current_user ? current_user.following?(@widget) : false}
  }

  if(user.is_logged_in){
    if(user.is_following){
      $("#follow").hide();
    } else {
      $("#unfollow").hide();
    }
  } else {
    $("#follow_status").hide();
  }

  var toggle_follow_status = function(){
    $("#follow").toggle();
    $("#unfollow").toggle();
  }

  $("#follow button").click(function(){
    toggle_follow_status();
    $.post("/follows/", {followable_type: 'widget', followable_id: widget_id}, function(){
      reload_hud();  
    });

  });

  $("#unfollow button").click(function(){
    toggle_follow_status();
    $.post("/follows/", {_method : "DELETE", followable_type: 'widget', followable_id: widget_id}, function(){
      reload_hud();
    });

  });  
      
  FB.XFBML.parse();
  
  var user = #{current_user ? current_user.id : 0};
  
  FB.Event.subscribe('comment.create',
      function(response) {
          widget_id = _.last(response.href.split('/')) * 1;
          if (user !== 0){
            $.post("/follows/", {followable_type: 'widget', followable_id: widget_id}, function(){
              reload_hud();
              });
          }
          mpq.push(["track","comment_added", {'type':"facebook", "widget":widget_id,"user": user}]);
      }
  );
  
  FB.Event.subscribe('comment.remove',
      function(response) {
          mpq.push(["track","comment_removed" , {'type' : "facebook", 'widget' : widget_id, "user": user}]);
      }
  );

